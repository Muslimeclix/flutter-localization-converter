<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flutter Localization Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      #excelOptions input[type="number"],
      #excelOptions input[type="text"] {
        padding: 6px;
        border: 1px solid #cbd5e0;
        border-radius: 4px;
      }

      #excelOptions label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }

      #excelOptions small {
        font-size: 0.8rem;
        color: #718096;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 40px;
        max-width: 800px;
        width: 100%;
        animation: slideIn 0.6s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      .header h1 {
        color: #2d3748;
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .header p {
        color: #718096;
        font-size: 1.1rem;
      }

      .conversion-tabs {
        display: flex;
        margin-bottom: 30px;
        background: #f7fafc;
        border-radius: 12px;
        padding: 4px;
      }

      .tab-btn {
        flex: 1;
        padding: 12px 24px;
        background: transparent;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #718096;
      }

      .tab-btn.active {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
      }

      .tab-content {
        display: none;
        animation: fadeIn 0.4s ease-in;
      }

      .tab-content.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .upload-area {
        border: 3px dashed #cbd5e0;
        border-radius: 12px;
        padding: 40px;
        text-align: center;
        margin-bottom: 30px;
        transition: all 0.3s ease;
        cursor: pointer;
        background: #f8fafc;
      }

      .upload-area:hover {
        border-color: #667eea;
        background: #f0f4ff;
        transform: translateY(-2px);
      }

      .upload-area.dragover {
        border-color: #667eea;
        background: #e6f3ff;
        transform: scale(1.02);
      }

      .upload-icon {
        font-size: 3rem;
        margin-bottom: 20px;
        color: #667eea;
      }

      .file-input {
        display: none;
      }

      .btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
        margin: 5px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
      }

      .btn:disabled {
        background: #a0aec0;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-secondary {
        background: linear-gradient(135deg, #48bb78, #38a169);
      }

      .btn-secondary:hover {
        box-shadow: 0 10px 25px rgba(72, 187, 120, 0.4);
      }

      .preview-section {
        margin-top: 30px;
        padding: 20px;
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
      }

      .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .preview-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2d3748;
      }

      .language-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .language-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        text-align: center;
        transition: all 0.3s ease;
      }

      .language-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .language-name {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 5px;
      }

      .language-count {
        color: #718096;
        font-size: 0.9rem;
      }

      .progress-bar {
        width: 100%;
        height: 6px;
        background: #e2e8f0;
        border-radius: 3px;
        overflow: hidden;
        margin-top: 8px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        transition: width 0.3s ease;
      }

      .status {
        padding: 12px;
        border-radius: 8px;
        margin: 10px 0;
        font-weight: 500;
      }

      .status.success {
        background: #f0fff4;
        color: #22543d;
        border: 1px solid #c6f6d5;
      }

      .status.error {
        background: #fed7d7;
        color: #742a2a;
        border: 1px solid #feb2b2;
      }

      .status.info {
        background: #ebf8ff;
        color: #2a4365;
        border: 1px solid #bee3f8;
      }

      .json-textarea {
        width: 100%;
        height: 300px;
        padding: 15px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-family: "Monaco", "Consolas", monospace;
        font-size: 0.9rem;
        resize: vertical;
        background: #f8fafc;
      }

      .json-textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .feature-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .feature-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        text-align: center;
        transition: all 0.3s ease;
      }

      .feature-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      .feature-icon {
        font-size: 2rem;
        margin-bottom: 15px;
        color: #667eea;
      }

      .feature-title {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 10px;
      }

      .feature-desc {
        color: #718096;
        font-size: 0.9rem;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üåç Flutter Localization Converter</h1>
        <p>
          Convert between Excel sheets and JSON localization files with ease
        </p>
      </div>

      <div class="conversion-tabs">
        <button class="tab-btn active" onclick="switchTab('excel-to-json')">
          üìä Excel to JSON
        </button>
        <button class="tab-btn" onclick="switchTab('json-to-excel')">
          üîÑ JSON to Excel
        </button>
      </div>

      <!-- Excel to JSON Tab -->
      <div id="excel-to-json" class="tab-content active">
        <!-- Add inside the Excel‚ÜíJSON tab, right after the upload area -->
            <div id="excelOptions" style="margin: 20px 0; padding: 15px; background: #f0f4ff; border-radius: 8px; display: block;">
              <h4>‚öôÔ∏è Conversion Options</h4>
              
              <div style="margin: 10px 0;">
                <label for="headerRow">Header Row (contains language names):</label>
                <input type="number" id="headerRow" min="1" value="1" style="width: 60px; margin-left: 10px;">
              </div>
              
              <div style="margin: 10px 0;">
                <label for="dataRows">Data Rows (key-value pairs):</label>
                <input type="text" id="dataRows" placeholder="e.g. 2-100 or 2-" value="2-" style="margin-left: 10px; width: 120px;">
                <small style="display: block; margin-top: 5px; color: #718096;">Use "2-" to include all rows after row 2</small>
              </div>
              
              <div style="margin: 10px 0;">
                <label>
                  <input type="checkbox" id="sanitizeKeys" checked>
                  Sanitize keys (spaces‚Üíunderscores, lowercase)
                </label>
              </div>
              <!-- idr paste krna hai usko bs -->
               <div class="format-selector" style="margin: 20px 0;">
                <h4>Select Output Format:</h4>
                <select id="outputFormat" style="padding: 8px; border-radius: 4px;">
                  <option value="json">JSON</option>
                  <option value="dart">Dart GetX Map</option>
                  <option value="arb">Flutter ARB</option>
                  <option value="map">Plain Map</option>
                </select>
              </div>
            </div>
        <div
          class="upload-area"
          id="excelUploadArea"
          onclick="document.getElementById('excelFile').click()"
        >
          <div class="upload-icon">üìÇ</div>
          <h3>Drop your Excel file here or click to browse</h3>
          <p>Supports .xlsx, .xls files</p>
          <input
            type="file"
            id="excelFile"
            class="file-input"
            accept=".xlsx,.xls"
            onchange="handleExcelFile(this.files[0])"
          />
        </div>
        
        <div id="excelPreview" style="display: none">
          <div class="preview-section">
            <div class="preview-header">
              <h3 class="preview-title">üìã Preview</h3>
              <div>
                <button class="btn btn-secondary" onclick="downloadAllJSON()">
                  <span
                    class="loading"
                    id="downloadLoading"
                    style="display: none"
                  ></span>
                  üíæ Download All JSON Files
                </button>
              </div>
            </div>
            <div id="languageGrid" class="language-grid"></div>
          </div>
        </div>
      </div>

      <!-- JSON to Excel Tab -->
      <div id="json-to-excel" class="tab-content">
        <div
          class="upload-area"
          id="jsonUploadArea"
          onclick="document.getElementById('jsonFiles').click()"
        >
          <div class="upload-icon">üìÑ</div>
          <h3>Drop your JSON files here or click to browse</h3>
          <p>Select multiple JSON localization files</p>
          <input
            type="file"
            id="jsonFiles"
            class="file-input"
            accept=".json"
            multiple
            onchange="handleJSONFiles(this.files)"
          />
        </div>

        <div style="margin: 20px 0">
          <h4>Or paste JSON content directly:</h4>
          <textarea
            id="jsonInput"
            class="json-textarea"
            placeholder='Paste your JSON here, e.g., {"hello": "Hello", "world": "World"}'
          ></textarea>
          <div style="margin-top: 10px">
            <input
              type="text"
              id="jsonLanguage"
              placeholder="Language code (e.g., en, es, fr)"
              style="
                padding: 8px;
                border: 1px solid #e2e8f0;
                border-radius: 4px;
                margin-right: 10px;
              "
            />
            <button class="btn" onclick="addJSONFromText()">‚ûï Add JSON</button>
          </div>
        </div>

        <div id="jsonPreview" style="display: none">
          <div class="preview-section">
            <div class="preview-header">
              <h3 class="preview-title">üìã JSON Files Preview</h3>
              <button class="btn btn-secondary" onclick="downloadExcel()">
                üìä Download Excel File
              </button>
            </div>
            <div id="jsonLanguageGrid" class="language-grid"></div>
          </div>
        </div>
      </div>

      <div id="statusMessage"></div>

      <!-- Features Section -->
      <div class="feature-grid">
        <div class="feature-card">
          <div class="feature-icon">üöÄ</div>
          <div class="feature-title">Smart Processing</div>
          <div class="feature-desc">
            Handles empty rows, missing translations, and various Excel formats
            automatically
          </div>
        </div>
        <div class="feature-card">
          <div class="feature-icon">üíæ</div>
          <div class="feature-title">Batch Download</div>
          <div class="feature-desc">
            Download all localization files as individual JSON files or combined
            Excel
          </div>
        </div>
        <div class="feature-card">
          <div class="feature-icon">üîÑ</div>
          <div class="feature-title">Bidirectional</div>
          <div class="feature-desc">
            Convert Excel to JSON and JSON back to Excel seamlessly
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentData = {};
      let jsonData = {};

      function sanitizeFileName(name) {
            return name
              .trim()
              .replace(/\s+/g, '_')
              .replace(/[^a-zA-Z0-9_]/g, '')
              .toLowerCase();
          }

          function convertToDartMap(lang, data) {
            let output = `final Map<String, String> ${sanitizeFileName(lang)} = {\n`;
            Object.entries(data).forEach(([key, value]) => {
              output += `  '${key}': '${escapeDartString(value)}',\n`;
            });
            output += '};';
            return output;
          }

          function convertToARB(lang, data) {
            return JSON.stringify({
              "@@locale": sanitizeFileName(lang),
              ...data
            }, null, 2);
          }

          function escapeDartString(str) {
            return str.replace(/'/g, "\\'");
          }

          function switchTab(tabId) {
  // Update tab buttons
            document.querySelectorAll(".tab-btn").forEach((btn) => btn.classList.remove("active"));
            event.target.classList.add("active");

            // Update tab content
            document.querySelectorAll(".tab-content").forEach((content) => content.classList.remove("active"));
            document.getElementById(tabId).classList.add("active");

            // Show/hide options panel
            const optionsPanel = document.getElementById('excelOptions');
            if (tabId === 'excel-to-json') {
              optionsPanel.style.display = 'block';
            } else {
              optionsPanel.style.display = 'none';
            }

            // Clear status
            showStatus("", "info");
          }

      // function switchTab(tabId) {
      //   // Update tab buttons
      //   document
      //     .querySelectorAll(".tab-btn")
      //     .forEach((btn) => btn.classList.remove("active"));
      //   event.target.classList.add("active");

      //   // Update tab content
      //   document
      //     .querySelectorAll(".tab-content")
      //     .forEach((content) => content.classList.remove("active"));
      //   document.getElementById(tabId).classList.add("active");

      //   const optionsPanel = document.getElementById('excelOptions');
      //       if (tabId === 'excel-to-json') {
      //         optionsPanel.style.display = 'block';
      //       } else {
      //         optionsPanel.style.display = 'none';
      //       }
      //   // Clear status
      //   showStatus("", "info");
      // }

      function showStatus(message, type = "info") {
        const statusEl = document.getElementById("statusMessage");
        statusEl.innerHTML = message
          ? `<div class="status ${type}">${message}</div>`
          : "";
      }

      // Excel to JSON functionality
      function handleExcelFile(file) {
        if (!file) return;

        // Validate file type
        const validTypes = [
          "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
          "application/vnd.ms-excel",
          "application/excel",
          "application/x-excel",
          "application/x-msexcel",
        ];

        const isValidType =
          validTypes.includes(file.type) ||
          file.name.toLowerCase().endsWith(".xlsx") ||
          file.name.toLowerCase().endsWith(".xls");

        if (!isValidType) {
          showStatus(
            "‚ùå Please select a valid Excel file (.xlsx or .xls)",
            "error"
          );
          return;
        }

        showStatus("üìä Processing Excel file...", "info");

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            // Try different reading methods for better compatibility
            let workbook;
            try {
              workbook = XLSX.read(e.target.result, {
                type: "array",
                cellDates: false,
                cellNF: false,
                cellStyles: false,
              });
            } catch (arrayError) {
              console.log("Array read failed, trying binary...", arrayError);
              workbook = XLSX.read(e.target.result, {
                type: "binary",
                cellDates: false,
                cellNF: false,
                cellStyles: false,
              });
            }

            if (
              !workbook ||
              !workbook.SheetNames ||
              workbook.SheetNames.length === 0
            ) {
              throw new Error("No sheets found in the Excel file");
            }

            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];

            if (!worksheet) {
              throw new Error("Unable to read the first sheet");
            }

            // Convert to JSON with better options
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {
              header: 1,
              defval: null,
              blankrows: false,
              raw: false,
            });

            console.log("Raw Excel data:", jsonData);

            if (!jsonData || jsonData.length === 0) {
              throw new Error("No data found in Excel file");
            }

            processExcelData(jsonData);
            showStatus("‚úÖ Excel file processed successfully!", "success");
          } catch (error) {
            console.error("Excel processing error:", error);
            showStatus(
              "‚ùå Error processing Excel file: " + error.message,
              "error"
            );
            showStatus(
              "üí° Tips: Make sure your Excel file has a header row with language names and data rows with keys and translations.",
              "info"
            );
          }
        };

        reader.onerror = function () {
          showStatus("‚ùå Error reading file. Please try again.", "error");
        };

        // Try reading as ArrayBuffer first, fallback to binary string
        try {
          reader.readAsArrayBuffer(file);
        } catch (error) {
          console.log(
            "ArrayBuffer read failed, trying binary string...",
            error
          );
          reader.readAsBinaryString(file);
        }
      }

      // function processExcelData(data) {
      //   currentData = {};

      //   // Filter out completely empty rows
      //   const filteredData = data.filter(
      //     (row) =>
      //       row &&
      //       Array.isArray(row) &&
      //       row.some(
      //         (cell) =>
      //           cell !== null &&
      //           cell !== undefined &&
      //           cell.toString().trim() !== ""
      //       )
      //   );

      //   if (filteredData.length < 2) {
      //     showStatus(
      //       "‚ùå Excel file must have at least a header row and one data row",
      //       "error"
      //     );
      //     return;
      //   }

      //   const headers = filteredData[0] || [];

      //   // Safe language extraction - handle null/undefined/empty values
      //   const languages = [];
      //   for (let i = 1; i < headers.length; i++) {
      //     const lang = headers[i];
      //     if (
      //       lang !== null &&
      //       lang !== undefined &&
      //       lang.toString().trim() !== ""
      //     ) {
      //       languages.push(lang.toString().trim());
      //     } else {
      //       // Add placeholder for empty column headers
      //       languages.push(`Language_${i}`);
      //     }
      //   }

      //   // Remove any trailing empty language columns
      //   while (
      //     languages.length > 0 &&
      //     languages[languages.length - 1].startsWith("Language_")
      //   ) {
      //     // Check if this column has any data
      //     let hasData = false;
      //     for (let rowIdx = 1; rowIdx < filteredData.length; rowIdx++) {
      //       const row = filteredData[rowIdx] || [];
      //       const cellValue = row[languages.length]; // +1 because we removed one
      //       if (
      //         cellValue !== null &&
      //         cellValue !== undefined &&
      //         cellValue.toString().trim() !== ""
      //       ) {
      //         hasData = true;
      //         break;
      //       }
      //     }
      //     if (!hasData) {
      //       languages.pop();
      //     } else {
      //       break;
      //     }
      //   }

      //   console.log("Detected languages:", languages);

      //   // Initialize language objects
      //   languages.forEach((lang) => {
      //     currentData[lang] = {};
      //   });

      //   // Process each row
      //   for (let i = 1; i < filteredData.length; i++) {
      //     const row = filteredData[i] || [];
      //     const key = row[0];

      //     // Skip rows without a key
      //     if (key === null || key === undefined || key.toString().trim() === "")
      //       continue;

      //     const cleanKey = key.toString().trim();

      //     // Process each language column
      //     languages.forEach((lang, langIndex) => {
      //       const colIndex = langIndex + 1; // +1 because first column is key
      //       const value = row[colIndex];

      //       if (
      //         value !== null &&
      //         value !== undefined &&
      //         value.toString().trim() !== ""
      //       ) {
      //         currentData[lang][cleanKey] = value.toString().trim();
      //       }
      //     });
      //   }

      //   // Remove languages with no translations
      //   const languagesToRemove = [];
      //   Object.keys(currentData).forEach((lang) => {
      //     if (Object.keys(currentData[lang]).length === 0) {
      //       languagesToRemove.push(lang);
      //     }
      //   });

      //   languagesToRemove.forEach((lang) => {
      //     delete currentData[lang];
      //   });

      //   console.log("Processed data:", currentData);

      //   if (Object.keys(currentData).length === 0) {
      //     showStatus(
      //       "‚ùå No valid translations found. Please check your Excel format.",
      //       "error"
      //     );
      //     return;
      //   }

      //   displayExcelPreview();
      // }
      function processExcelData(data) {
                                          currentData = {};

                                          // Get user options
                                          const headerRow = parseInt(document.getElementById('headerRow').value) - 1; // convert to 0-based
                                          const dataRows = document.getElementById('dataRows').value.trim();
                                          const sanitize = document.getElementById('sanitizeKeys').checked;

                                          // Validate header row
                                          if (headerRow < 0 || headerRow >= data.length) {
                                            showStatus("‚ùå Invalid header row number", "error");
                                            return;
                                          }

                                          // Parse data row range
                                          let startRow, endRow;
                                          try {
                                            if (dataRows.includes('-')) {
                                              [start, end] = dataRows.split('-').map(n => n.trim() === '' ? null : parseInt(n) - 1);
                                              startRow = start || 0;
                                              endRow = end === null ? data.length - 1 : end;
                                            } else {
                                              startRow = parseInt(dataRows) - 1;
                                              endRow = data.length - 1;
                                            }
                                          } catch (e) {
                                            showStatus("‚ùå Invalid row range format", "error");
                                            return;
                                          }

                                          // Extract languages from header row
                                          const languages = data[headerRow].slice(1).filter(cell => cell !== null);

                                          // Initialize language objects
                                          languages.forEach(lang => {
                                            currentData[lang] = {};
                                          });

                                          // Process data rows
                                          for (let i = startRow; i <= endRow && i < data.length; i++) {
                                            const row = data[i];
                                            if (!row || row.length === 0) continue;

                                            let key = row[0]?.toString().trim() || '';
                                            if (sanitize) {
                                              key = key
                                                .toLowerCase()
                                                .replace(/\s+/g, '_')
                                                .replace(/[^a-z0-9_]/g, '');
                                            }

                                            if (!key) continue;

                                            // Process each language column
                                            languages.forEach((lang, idx) => {
                                              const value = row[idx + 1]; // +1 because first column is key
                                              if (value !== null && value !== undefined) {
                                                currentData[lang][key] = value.toString().trim();
                                              }
                                            });
                                          }

                                          // Remove languages with no translations
                                          Object.keys(currentData).forEach(lang => {
                                            if (Object.keys(currentData[lang]).length === 0) {
                                              delete currentData[lang];
                                            }
                                          });

                                          displayExcelPreview();
                                          showStatus("‚úÖ Excel processed with custom options!", "success");
                                        }

      function displayExcelPreview() {
        const previewEl = document.getElementById("excelPreview");
        const gridEl = document.getElementById("languageGrid");

        gridEl.innerHTML = "";

        Object.keys(currentData).forEach((lang) => {
          const keyCount = Object.keys(currentData[lang]).length;
          const totalPossibleKeys = Math.max(
            ...Object.values(currentData).map(
              (langData) => Object.keys(langData).length
            )
          );
          const completionPercentage =
            totalPossibleKeys > 0
              ? Math.round((keyCount / totalPossibleKeys) * 100)
              : 0;

          const card = document.createElement("div");
          card.className = "language-card";
          card.innerHTML = `
                    <div class="language-name">${lang}</div>
                    <div class="language-count">${keyCount} translations</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${completionPercentage}%"></div>
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn" onclick="downloadSingleJSON('${lang}')" style="font-size: 0.8rem; padding: 6px 12px;">
                            üíæ Download
                        </button>
                    </div>
                `;
          gridEl.appendChild(card);
        });

        previewEl.style.display = "block";
      }

      // Modified download functions:
async function downloadSingleJSON(language) {
  try {
    const format = document.getElementById('outputFormat').value;
    let content, filename, mimeType;
    
    switch(format) {
      case 'dart':
        content = convertToDartMap(language, currentData[language]);
        filename = `${sanitizeFileName(language)}.dart`;
        mimeType = 'application/dart';
        break;
      case 'arb':
        content = convertToARB(language, currentData[language]);
        filename = `${sanitizeFileName(language)}.arb`;
        mimeType = 'application/json';
        break;
      case 'map':
        content = JSON.stringify(currentData[language], null, 2);
        filename = `${sanitizeFileName(language)}.json`;
        mimeType = 'application/json';
        break;
      default: // json
        content = JSON.stringify(currentData[language], null, 2);
        filename = `${sanitizeFileName(language)}.json`;
        mimeType = 'application/json';
    }

    const success = await downloadFile(filename, content, mimeType);
    if (success !== false) {
      showStatus(`‚úÖ Downloaded ${filename} successfully!`, "success");
    }
  } catch (error) {
    showStatus(`‚ùå Error downloading ${language}: ${error.message}`, "error");
  }
}
   async function downloadAllJSON() {
  const loadingEl = document.getElementById("downloadLoading");
  loadingEl.style.display = "inline-block";

  try {
    const zip     = new JSZip();
    const format  = document.getElementById("outputFormat").value;

    for (const lang of Object.keys(currentData)) {
      const data = currentData[lang];

      let content, filename;

      switch (format) {
        case "dart":
          content  = convertToDartMap(lang, data);
          filename = `${sanitizeFileName(lang)}.dart`;
          break;

        case "arb":
          content  = convertToARB(lang, data);
          filename = `${sanitizeFileName(lang)}.arb`;
          break;

        case "map":
          content  = JSON.stringify(data, null, 2);
          filename = `${sanitizeFileName(lang)}.json`;
          break;

        default: // "json"
          content  = JSON.stringify(data, null, 2);
          filename = `${sanitizeFileName(lang)}.json`;
          break;
      }

      zip.file(filename, content);
    }

    const blob   = await zip.generateAsync({ type: "blob" });
    const zipName = `flutter_localizations_${format}.zip`;

    const success = await downloadFile(zipName, blob, "application/zip");
    if (success !== false) {
      showStatus(`‚úÖ All ${format.toUpperCase()} files zipped successfully!`, "success");
    }
  } catch (error) {
    showStatus(`‚ùå ZIP creation failed: ${error.message}`, "error");
  } finally {
    loadingEl.style.display = "none";
  }
}  // Enhanced JSON parsing (replace your existing JSON parsing):
function parseFlexibleJSON(text) {
  try {
    // Try standard JSON first
    return parseFlexibleJSON(text);
  } catch (e) {
    try {
      // Try single quotes replacement
      const singleQuoted = text.replace(/'/g, '"');
      return parseFlexibleJSON(singleQuoted);
    } catch (e2) {
      try {
        // Try as plain JavaScript object
        // eslint-disable-next-line no-eval
        return eval(`(${text})`);
      } catch (e3) {
        throw new Error('Invalid JSON format. Please check your input.');
      }
    }
  }
}

      // JSON to Excel functionality
      function handleJSONFiles(files) {
        jsonData = {};
        let processedCount = 0;

        Array.from(files).forEach((file) => {
          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const content = parseFlexibleJSON(e.target.result);
              const langCode = file.name.replace(".json", "");
              jsonData[langCode] = content;
              processedCount++;

              if (processedCount === files.length) {
                displayJSONPreview();
                showStatus(
                  `‚úÖ Processed ${processedCount} JSON files`,
                  "success"
                );
              }
            } catch (error) {
              showStatus(
                `‚ùå Error parsing ${file.name}: ${error.message}`,
                "error"
              );
            }
          };
          reader.readAsText(file);
        });
      }

      function addJSONFromText() {
        const jsonInput = document.getElementById("jsonInput").value.trim();
        const langCode = document.getElementById("jsonLanguage").value.trim();

        if (!jsonInput || !langCode) {
          showStatus(
            "‚ùå Please provide both JSON content and language code",
            "error"
          );
          return;
        }

        try {
          const content = parseFlexibleJSON(jsonInput);
          jsonData[langCode] = content;
          displayJSONPreview();

          // Clear inputs
          document.getElementById("jsonInput").value = "";
          document.getElementById("jsonLanguage").value = "";

          showStatus(`‚úÖ Added ${langCode} JSON`, "success");
        } catch (error) {
          showStatus("‚ùå Invalid JSON format: " + error.message, "error");
        }
      }

      function displayJSONPreview() {
        const previewEl = document.getElementById("jsonPreview");
        const gridEl = document.getElementById("jsonLanguageGrid");

        gridEl.innerHTML = "";

        Object.keys(jsonData).forEach((lang) => {
          const keyCount = Object.keys(jsonData[lang]).length;

          const card = document.createElement("div");
          card.className = "language-card";
          card.innerHTML = `
                    <div class="language-name">${lang}</div>
                    <div class="language-count">${keyCount} keys</div>
                    <div style="margin-top: 10px;">
                        <button class="btn" onclick="removeLanguage('${lang}')" style="font-size: 0.8rem; padding: 6px 12px; background: #e53e3e;">
                            üóëÔ∏è Remove
                        </button>
                    </div>
                `;
          gridEl.appendChild(card);
        });

        previewEl.style.display = "block";
      }

      function removeLanguage(lang) {
        delete jsonData[lang];
        displayJSONPreview();
        showStatus(`üóëÔ∏è Removed ${lang}`, "info");
      }

      async function downloadExcel() {
        try {
          // Collect all unique keys
          const allKeys = new Set();
          Object.values(jsonData).forEach((langData) => {
            Object.keys(langData).forEach((key) => allKeys.add(key));
          });

          const sortedKeys = Array.from(allKeys).sort();
          const languages = Object.keys(jsonData).sort();

          // Create Excel data
          const excelData = [];
          const header = ["Key", ...languages];
          excelData.push(header);

          sortedKeys.forEach((key) => {
            const row = [key];
            languages.forEach((lang) => {
              row.push(jsonData[lang][key] || "");
            });
            excelData.push(row);
          });

          // Create workbook
          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.aoa_to_sheet(excelData);
          XLSX.utils.book_append_sheet(wb, ws, "Localizations");

          // Convert to blob
          const excelBuffer = XLSX.write(wb, {
            bookType: "xlsx",
            type: "array",
          });
          const blob = new Blob([excelBuffer], {
            type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
          });

          const success = await downloadFile(
            "localizations.xlsx",
            blob,
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
          );
          if (success !== false) {
            showStatus("‚úÖ Excel file downloaded successfully!", "success");
          }
        } catch (error) {
          showStatus("‚ùå Error creating Excel file: " + error.message, "error");
        }
      }

      function downloadFile(filename, content, mimeType) {
        try {
          // Check if File System Access API is supported (Chrome, Edge)
          if ("showSaveFilePicker" in window) {
            downloadWithFilePicker(filename, content, mimeType);
          } else {
            // Fallback for other browsers
            downloadWithFallback(filename, content, mimeType);
          }
        } catch (error) {
          console.error("Download error:", error);
          downloadWithFallback(filename, content, mimeType);
        }
      }

      async function downloadWithFilePicker(filename, content, mimeType) {
        try {
          const options = {
            suggestedName: filename,
            types: [],
          };

          // Set appropriate file type filters
          if (mimeType === "application/json") {
            options.types = [
              {
                description: "JSON files",
                accept: { "application/json": [".json"] },
              },
            ];
          } else if (mimeType === "application/zip") {
            options.types = [
              {
                description: "ZIP files",
                accept: { "application/zip": [".zip"] },
              },
            ];
          } else if (
            mimeType ===
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
          ) {
            options.types = [
              {
                description: "Excel files",
                accept: {
                  "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":
                    [".xlsx"],
                },
              },
            ];
          }

          const fileHandle = await window.showSaveFilePicker(options);
          const writable = await fileHandle.createWritable();

          if (typeof content === "string") {
            await writable.write(content);
          } else {
            await writable.write(content);
          }

          await writable.close();
          return true;
        } catch (error) {
          if (error.name === "AbortError") {
            showStatus("üìÅ Save cancelled by user", "info");
            return false;
          } else {
            console.error("File picker error:", error);
            // Fallback to traditional download
            downloadWithFallback(filename, content, mimeType);
            return true;
          }
        }
      }

      function downloadWithFallback(filename, content, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.style.display = "none";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Drag and drop functionality
      function setupDragDrop() {
        const excelArea = document.getElementById("excelUploadArea");
        const jsonArea = document.getElementById("jsonUploadArea");

        [excelArea, jsonArea].forEach((area) => {
          area.addEventListener("dragover", (e) => {
            e.preventDefault();
            area.classList.add("dragover");
          });

          area.addEventListener("dragleave", () => {
            area.classList.remove("dragover");
          });

          area.addEventListener("drop", (e) => {
            e.preventDefault();
            area.classList.remove("dragover");

            const files = e.dataTransfer.files;
            if (area === excelArea && files.length === 1) {
              handleExcelFile(files[0]);
            } else if (area === jsonArea) {
              handleJSONFiles(files);
            }
          });
        });
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", setupDragDrop);
    </script>
  </body>
</html>
